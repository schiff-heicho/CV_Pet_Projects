# Хранимых процедур и функций для базы данных <Физтех.вино>

### Общее описание
Файл functions_and_procedures.sql содержит реализацию бизнес-логики базы данных виннного магазина через хранимые процедуры и функции, обеспечивающие автоматизацию ключевых операций.

## Список объектов

### 1. Хранимые процедуры

**process_order**
Оформляет новый заказ с автоматической проверкой наличия товара. Выполняет:
- Проверку остатков на складе
- Создание записи заказа
- Обновление инвентаря
- Обработку ошибок при недостатке товара

**update_wine_price**
Обновляет цену вина с сохранением истории изменений. Особенности:
- Деактивирует предыдущую цену
- Сохраняет новую цену в истории
- Обновляет основную таблицу вин

### 2. Функции

**calculate_loyalty_status**
Определяет статус лояльности клиента по сумме покупок:
- Возвращает 'VIP' для суммы >50,000
- 'Premium' для суммы 20,000-50,000
- 'Standard' для суммы <20,000

**get_available_quantity**
Возвращает количество доступного вина в указанном магазине:
- Принимает ID вина и магазина
- Возвращает 0 если товар отсутствует

## Рекомендации по использованию

1. **Вызов процедур**:
   - Для оформления заказа используйте process_order с параметрами клиента, магазина, вина и количества
   - Для обновления цены вызовите update_wine_price с указанием ID вина и новой цены

2. **Использование функций**:
   - calculate_loyalty_status применяйте в клиентских отчетах
   - get_available_quantity используйте при проверке остатков

3. **Мониторинг**:
   - Регулярно проверяйте производительность через performance_schema
   - Обновляйте статистику таблиц после массовых операций

## Особенности реализации

- **Безопасность**: Все операции защищены транзакциями
- **Производительность**: Оптимизированные запросы с использованием индексов
- **Надежность**: Полная обработка ошибок и исключительных ситуаций
- **Аудит**: Сохранение истории изменений для критических данных
