DROP TABLE IF EXISTS wine_regions;
CREATE TABLE wine_regions (
    region_id SERIAL PRIMARY KEY,
    region_name VARCHAR(128) NOT NULL UNIQUE,
    subregion_name VARCHAR(128) NOT NULL,
    country VARCHAR(64) NOT NULL,
    climate VARCHAR(64) NOT NULL
);

DROP TABLE IF EXISTS wines;
CREATE TABLE wines (
    wine_id SERIAL PRIMARY KEY,
    name VARCHAR(128) NOT NULL,
    region_id INT REFERENCES wine_regions(region_id),
    production_year INT NOT NULL CHECK (production_year BETWEEN 1900 AND 2100),
    type VARCHAR(20) NOT NULL CHECK (type IN ('красное', 'белое', 'роза', 'игристое')),
    price DECIMAL(10, 2) NOT NULL CHECK (price > 0),
    rating DECIMAL(3, 1) CHECK (rating BETWEEN 0 AND 10)
);

DROP TABLE IF EXISTS wine_price_history;
CREATE TABLE wine_price_history (
    price_history_id SERIAL PRIMARY KEY,
    wine_id INT REFERENCES wines(wine_id),
    start_date DATE NOT NULL,
    end_date DATE CHECK (end_date > start_date),
    price DECIMAL(10, 2) NOT NULL CHECK (price > 0),
    is_current BOOLEAN DEFAULT TRUE
);

DROP TABLE IF EXISTS locations;
CREATE TABLE locations (
    location_id SERIAL PRIMARY KEY,
    name VARCHAR(128) NOT NULL,
    country VARCHAR(64) NOT NULL,
    city VARCHAR(64) NOT NULL,
    address VARCHAR(128) NOT NULL,
    type VARCHAR(10) NOT NULL CHECK (type IN ('online', 'offline'))
);

DROP TABLE IF EXISTS customers;
CREATE TABLE customers (
    customer_id SERIAL PRIMARY KEY,
    first_name VARCHAR(64) NOT NULL,
    last_name VARCHAR(64) NOT NULL,
    email VARCHAR(64) UNIQUE NOT NULL,
    city VARCHAR(64) NOT NULL,
    loyalty_card BOOLEAN DEFAULT FALSE
);

DROP TABLE IF EXISTS inventory;
CREATE TABLE inventory (
    wine_id INT REFERENCES wines(wine_id),
    location_id INT REFERENCES locations(location_id),
    quantity INT NOT NULL CHECK (quantity >= 0),
    last_delivery_date DATE NOT NULL,
    PRIMARY KEY(wine_id, location_id)
);

DROP TABLE IF EXISTS orders;
CREATE TABLE orders (
    order_id SERIAL PRIMARY KEY,
    customer_id INT REFERENCES customers(customer_id),
    order_date TIMESTAMP DEFAULT CURRENT_TIMESTAMP NOT NULL,
    order_type VARCHAR(10) NOT NULL CHECK (order_type IN ('online', 'offline')),
    location_id INT REFERENCES locations(location_id),
    status VARCHAR(20) DEFAULT 'processing' NOT NULL CHECK (status IN ('completed', 'processing'))
);

DROP TABLE IF EXISTS order_details;
CREATE TABLE order_details (
    order_details_id SERIAL PRIMARY KEY,
    order_id INT REFERENCES orders(order_id),
    wine_id INT REFERENCES wines(wine_id),
    quantity INT NOT NULL CHECK (quantity > 0)
);
